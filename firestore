import firebase_admin
from firebase_admin import credentials, firestore
import json

# 初始化Firebase应用的函数
cred = credentials.Certificate('D:/Download/final-project-1c953-firebase-adminsdk-dzoi0-df6d7af5b9.json')


db = firestore.client()
import json

tweets_seen = set()  # To track tweet IDs we've already processed
users = {}  # To track users and some information about them
retweets_count = 0  # To count the number of retweets
tweets_datastore = {}  # To store tweets' information

with open("corona-out-3", "r") as f1:
    for line in f1:
        # Skip empty lines or lines that do not start with '{'
        line = line.strip()
        if not line or not line.startswith('{'):
            continue

        try:
            data = json.loads(line)
            tweet_id = data.get('id_str')  # Use .get to avoid KeyError if 'id_str' is missing

            # Check if the tweet has been seen before
            if tweet_id in tweets_seen:
                continue  # Skip this tweet

            # Only process if tweet_id is not None
            if tweet_id:
                tweets_seen.add(tweet_id)  # Mark this tweet as seen

                user_id = data['user'].get('id_str')  # Use .get to avoid KeyError if 'id_str' is missing
                user = data['user']

                # Check if the user has been seen before; if not, add to users dictionary
                if user_id and user_id not in users:
                    users[user_id] = user  # For simplicity, storing the whole user object

                # Check if it's a retweet
                if data['text'].startswith('RT'):
                    retweets_count += 1  # Update retweet information
                else:
                    # Add the new tweet to datastore
                    tweets_datastore[tweet_id] = data
        except Exception as e:
            print(f"Error processing line: {e}")
            continue

# At this point, you can use tweets_seen, users, retweets_count, and tweets_datastore as needed

# 假设tweets_datastore是包含你想存储的推文数据的字典
for tweet_id, tweet_data in tweets_datastore.items():
    try:
        # 将推文数据存储到Firestore中
        db.collection('tweets').document(str(tweet_id)).set(tweet_data)
        print(f"Tweet with ID {tweet_id} successfully stored in Firestore.")
    except Exception as e:
        print(f"Error storing tweet with ID {tweet_id} in Firestore: {e}")

